<div class="dashboard">
    <div class="dashboard-title">
        <span class="live-indicator"></span>
        ü™ô BTC/USD Trading Dashboard
        <span class="websocket-badge" id="ws-status">‚ö° CONNECTING...</span>
    </div>
    
    <div class="status-bar">
        üïê <span id="current-time">--:--:--</span> | 
        üìä <span id="connection-status">Initializing...</span>
    </div>
    
    <div class="settings-toggle">
        <button onclick="toggleSettings()">‚öôÔ∏è Settings</button>
    </div>
    
    <div class="settings-panel" id="settings-panel">
        <div class="settings-grid">
            <div class="setting-item">
                <label>Account Balance ($)</label>
                <input type="number" id="balance" value="10000" onchange="updateSettings()">
            </div>
            <div class="setting-item">
                <label>Risk per Trade (%)</label>
                <input type="number" id="risk" value="2" step="0.1" onchange="updateSettings()">
            </div>
            <div class="setting-item">
                <label>Oscillator Weight (%)</label>
                <input type="number" id="osc-weight" value="60" onchange="updateSettings()">
            </div>
            <div class="setting-item">
                <label>MA Weight (%)</label>
                <input type="number" id="ma-weight" value="40" readonly>
            </div>
            <div class="setting-item">
                <label>ATR Period (n)</label>
                <input type="number" id="atr-period" value="14" min="5" max="50" onchange="updateSettings()">
            </div>
        </div>
    </div>
    
    <div class="live-price-box">
        <div class="live-price-label">üí∞ LIVE BTC/USD PRICE</div>
        <div class="live-price" id="live-price">$--,---</div>
        <div class="price-change" id="price-change">--</div>
    </div>
    
    <table class="dashboard-table">
        <thead>
            <tr>
                <th>Time Left</th>
                <th>Next Sequence</th>
                <th>Signal</th>
                <th>Action</th>
                <th>Confidence</th>
                <th>Position Size</th>
                <th>ATR</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="time-left" id="time-left">--:--</td>
                <td id="next-sequence">--:--</td>
                <td id="signal">--</td>
                <td class="signal-arrow" id="action">--</td>
                <td>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidence-fill" style="width: 0%;">0%</div>
                    </div>
                </td>
                <td id="position-size">$-- USD</td>
                <td id="atr">$--</td>
            </tr>
        </tbody>
    </table>
    
    <div class="info-grid">
        <div class="info-box">
            <div class="info-row">
                <span class="info-label">Account Balance:</span>
                <span id="display-balance">$10,000</span>
            </div>
            <div class="info-row">
                <span class="info-label">Risk per Trade:</span>
                <span id="display-risk">2.0%</span>
            </div>
            <div class="info-row">
                <span class="info-label">Data Source:</span>
                <span id="data-source">Kraken WebSocket</span>
            </div>
        </div>
        
        <div class="info-box">
            <div class="info-row">
                <span class="info-label">RSI Value:</span>
                <span id="rsi-value">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Oscillator Signal:</span>
                <span id="osc-signal">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">MA Signal:</span>
                <span id="ma-signal">--</span>
            </div>
        </div>
    </div>
</div>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
.dashboard { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 30px; border-radius: 20px; color: white; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-width: 1200px; width: 100%; }
.dashboard-title { text-align: center; font-size: 32px; font-weight: bold; margin-bottom: 25px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
.live-indicator { display: inline-block; width: 14px; height: 14px; background: #00ff00; border-radius: 50%; animation: pulse 2s infinite; margin-right: 10px; }
@keyframes pulse { 0%, 100% { opacity: 1; box-shadow: 0 0 10px #00ff00; } 50% { opacity: 0.3; box-shadow: 0 0 5px #00ff00; } }
.websocket-badge { display: inline-block; background: rgba(0,255,0,0.2); padding: 6px 14px; border-radius: 15px; font-size: 13px; color: #00ff88; border: 1px solid #00ff88; margin-left: 12px; }
.status-bar { text-align: center; font-size: 14px; color: #ffc107; margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
.live-price-box { text-align: center; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 2px solid rgba(0,255,136,0.3); }
.live-price-label { font-size: 16px; color: #ffc107; margin-bottom: 8px; }
.live-price { font-size: 48px; font-weight: bold; color: #00ff88; text-shadow: 0 0 20px rgba(0,255,136,0.5); transition: all 0.3s ease; }
.price-change { font-size: 18px; margin-top: 8px; font-weight: bold; }
.price-up { color: #28a745; }
.price-down { color: #dc3545; }
.dashboard-table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden; margin-bottom: 25px; }
.dashboard-table th { background: rgba(0,0,0,0.4); padding: 15px; text-align: center; font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
.dashboard-table td { padding: 18px; text-align: center; font-size: 16px; border-top: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; }
.time-left { font-size: 28px; color: #ffc107; font-weight: bold; font-family: 'Courier New', monospace; }
.signal-arrow { font-size: 32px; font-weight: bold; transition: all 0.3s ease; }
.confidence-bar { width: 100%; height: 30px; background: rgba(255,255,255,0.2); border-radius: 15px; overflow: hidden; position: relative; }
.confidence-fill { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; transition: width 0.5s ease, background 0.3s ease; }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
.info-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
.info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
.info-row:last-child { border-bottom: none; }
.info-label { font-weight: bold; color: #ffc107; }
.settings-panel { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none; }
.settings-toggle { text-align: center; margin-bottom: 15px; }
.settings-toggle button { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; }
.settings-toggle button:hover { background: rgba(255,255,255,0.2); }
.settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
.setting-item label { display: block; color: #ffc107; margin-bottom: 5px; font-size: 13px; }
.setting-item input { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 14px; }
</style>

<script>
let config = { balance: 10000, risk: 0.02, oscWeight: 0.6, maWeight: 0.4, atrPeriod: 14 };
let ws = null, currentPrice = null, previousPrice = null, historicalPrices = [];
let historicalCandles = []; // Store OHLC data for proper ATR

function updateTime() {
    document.getElementById('current-time').textContent = new Date().toLocaleTimeString();
    updateCountdown();
}

function updateCountdown() {
    const now = new Date();
    const minute = now.getMinutes(), second = now.getSeconds();
    const nextMinute = Math.ceil((minute + 1) / 15) * 15;
    const nextTime = new Date(now);
    if (nextMinute >= 60) { nextTime.setHours(nextTime.getHours() + 1); nextTime.setMinutes(0); }
    else { nextTime.setMinutes(nextMinute); }
    nextTime.setSeconds(0);
    const diff = nextTime - now;
    const mins = Math.floor(diff / 60000), secs = Math.floor((diff % 60000) / 1000);
    document.getElementById('time-left').textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    document.getElementById('next-sequence').textContent = nextTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
}

function connectWebSocket() {
    document.getElementById('connection-status').textContent = 'Connecting to Kraken...';
    ws = new WebSocket('wss://ws.kraken.com');
    ws.onopen = function() {
        console.log('Connected to Kraken WebSocket');
        document.getElementById('ws-status').textContent = '‚ö° LIVE';
        document.getElementById('connection-status').textContent = 'Connected - Streaming live data';
        ws.send(JSON.stringify({ event: 'subscribe', pair: ['XBT/USD'], subscription: { name: 'ticker' } }));
    };
    ws.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (Array.isArray(data) && data.length > 1 && data[1].c) {
                previousPrice = currentPrice;
                currentPrice = parseFloat(data[1].c[0]);
                updatePrice();
            }
        } catch (e) { console.error('Error parsing message:', e); }
    };
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        document.getElementById('ws-status').textContent = '‚ùå ERROR';
        document.getElementById('connection-status').textContent = 'Connection error';
    };
    ws.onclose = function() {
        console.log('WebSocket closed');
        document.getElementById('ws-status').textContent = '‚ö†Ô∏è DISCONNECTED';
        document.getElementById('connection-status').textContent = 'Disconnected - Reconnecting...';
        setTimeout(connectWebSocket, 5000);
    };
}

function updatePrice() {
    if (!currentPrice) return;
    const priceElement = document.getElementById('live-price');
    const changeElement = document.getElementById('price-change');
    priceElement.textContent = `${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    if (previousPrice && currentPrice !== previousPrice) {
        const change = currentPrice - previousPrice;
        const changePercent = (change / previousPrice) * 100;
        changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
        changeElement.className = change >= 0 ? 'price-change price-up' : 'price-change price-down';
        priceElement.style.transform = 'scale(1.05)';
        setTimeout(() => { priceElement.style.transform = 'scale(1)'; }, 300);
    }
    historicalPrices.push(currentPrice);
    if (historicalPrices.length > 50) historicalPrices.shift();
}

async function fetchHistoricalData() {
    try {
        const since = Math.floor((Date.now() - 24 * 60 * 60 * 1000) / 1000);
        const response = await fetch(`https://api.kraken.com/0/public/OHLC?pair=XBTUSD&interval=15&since=${since}`);
        const data = await response.json();
        if (data.result) {
            const key = Object.keys(data.result).find(k => k !== 'last');
            if (key) {
                // Store OHLC candles: [time, open, high, low, close, vwap, volume, count]
                historicalCandles = data.result[key].slice(-50).map(candle => ({
                    time: candle[0],
                    open: parseFloat(candle[1]),
                    high: parseFloat(candle[2]),
                    low: parseFloat(candle[3]),
                    close: parseFloat(candle[4])
                }));
                historicalPrices = historicalCandles.map(c => c.close);
                console.log('Loaded historical data:', historicalCandles.length, 'candles');
            }
        }
    } catch (e) { console.error('Error fetching historical data:', e); }
}

function calculateSignals() {
    if (!currentPrice || historicalPrices.length < 14) return { signal: 'NEUTRAL', osc: 'NEUTRAL', ma: 'NEUTRAL', confidence: 50, rsi: 50 };
    const sma20 = historicalPrices.slice(-20).reduce((a, b) => a + b, 0) / Math.min(20, historicalPrices.length);
    const sma50 = historicalPrices.reduce((a, b) => a + b, 0) / historicalPrices.length;
    const changes = [];
    for (let i = 1; i < Math.min(15, historicalPrices.length); i++) {
        changes.push(historicalPrices[historicalPrices.length - i] - historicalPrices[historicalPrices.length - i - 1]);
    }
    const gains = changes.filter(c => c > 0);
    const losses = changes.filter(c => c < 0).map(Math.abs);
    const avgGain = gains.length > 0 ? gains.reduce((a, b) => a + b, 0) / gains.length : 0;
    const avgLoss = losses.length > 0 ? losses.reduce((a, b) => a + b, 0) / losses.length : 0.001;
    const rs = avgGain / avgLoss;
    const rsi = 100 - (100 / (1 + rs));
    let oscVal, oscRec;
    if (rsi < 30) { oscVal = 1.0; oscRec = 'STRONG_BUY'; }
    else if (rsi < 40) { oscVal = 0.5; oscRec = 'BUY'; }
    else if (rsi > 70) { oscVal = -1.0; oscRec = 'STRONG_SELL'; }
    else if (rsi > 60) { oscVal = -0.5; oscRec = 'SELL'; }
    else { oscVal = 0; oscRec = 'NEUTRAL'; }
    let maVal, maRec;
    if (currentPrice > sma20 && sma20 > sma50) { maVal = 1.0; maRec = 'STRONG_BUY'; }
    else if (currentPrice > sma20) { maVal = 0.5; maRec = 'BUY'; }
    else if (currentPrice < sma20 && sma20 < sma50) { maVal = -1.0; maRec = 'STRONG_SELL'; }
    else if (currentPrice < sma20) { maVal = -0.5; maRec = 'SELL'; }
    else { maVal = 0; maRec = 'NEUTRAL'; }
    const weighted = (oscVal * config.oscWeight) + (maVal * config.maWeight);
    const signal = weighted > 0 ? 'BUY UP' : weighted < 0 ? 'BUY DOWN' : 'NEUTRAL';
    const confidence = Math.min(100, Math.abs(weighted) * 100 + (oscRec === maRec ? 15 : 0));
    return { signal, osc: oscRec, ma: maRec, confidence, rsi };
}

function calculateATR() {
    if (historicalCandles.length < config.atrPeriod + 1) return 500; // Default if not enough data
    
    const n = config.atrPeriod;
    const trValues = [];
    
    // Calculate True Range for each period
    for (let i = 1; i < historicalCandles.length; i++) {
        const current = historicalCandles[i];
        const previous = historicalCandles[i - 1];
        
        // True Range is the greatest of:
        // 1. Current High - Current Low
        const range1 = current.high - current.low;
        // 2. Current High - Previous Close
        const range2 = Math.abs(current.high - previous.close);
        // 3. Current Low - Previous Close
        const range3 = Math.abs(current.low - previous.close);
        
        const trueRange = Math.max(range1, range2, range3);
        trValues.push(trueRange);
    }
    
    if (trValues.length < n) return 500;
    
    // Calculate first ATR (simple average of first n true ranges)
    let atr = trValues.slice(0, n).reduce((sum, tr) => sum + tr, 0) / n;
    
    // Calculate subsequent ATRs using smoothing formula
    for (let i = n; i < trValues.length; i++) {
        atr = ((atr * (n - 1)) + trValues[i]) / n;
    }
    
    return atr;
}

function calculatePositionSize(confidence, atr) {
    if (!currentPrice || atr === 0) return 0;
    
    // Position size in USD based on account balance and risk per trade
    const accountRisk = config.balance * config.risk;
    const confidenceFactor = confidence / 100;
    
    // Recommended position size in USD
    const positionUSD = accountRisk * confidenceFactor;
    
    return positionUSD;
}

function updateDashboard() {
    if (!currentPrice) return;
    const signals = calculateSignals();
    const atr = calculateATR();
    const positionSizeUSD = calculatePositionSize(signals.confidence, atr);
    
    document.getElementById('signal').textContent = signals.signal;
    const arrow = signals.signal === 'BUY UP' ? '‚Üë' : signals.signal === 'BUY DOWN' ? '‚Üì' : '‚Äî';
    const arrowColor = signals.signal === 'BUY UP' ? '#28a745' : signals.signal === 'BUY DOWN' ? '#dc3545' : '#6c757d';
    const actionEl = document.getElementById('action');
    actionEl.textContent = `${arrow} ${signals.signal}`;
    actionEl.style.color = arrowColor;
    const confColor = signals.confidence >= 70 ? '#28a745' : signals.confidence >= 40 ? '#ffc107' : '#dc3545';
    const confFill = document.getElementById('confidence-fill');
    confFill.style.width = `${signals.confidence}%`;
    confFill.style.background = confColor;
    confFill.textContent = `${signals.confidence.toFixed(0)}%`;
    document.getElementById('position-size').textContent = `${positionSizeUSD.toFixed(2)} USD`;
    document.getElementById('atr').textContent = `${atr.toFixed(2)}`;
    document.getElementById('rsi-value').textContent = signals.rsi.toFixed(1);
    document.getElementById('osc-signal').textContent = signals.osc;
    document.getElementById('ma-signal').textContent = signals.ma;
}

function toggleSettings() {
    const panel = document.getElementById('settings-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function updateSettings() {
    config.balance = parseFloat(document.getElementById('balance').value) || 10000;
    config.risk = (parseFloat(document.getElementById('risk').value) || 2) / 100;
    config.oscWeight = (parseFloat(document.getElementById('osc-weight').value) || 60) / 100;
    config.maWeight = 1 - config.oscWeight;
    config.atrPeriod = parseInt(document.getElementById('atr-period').value) || 14;
    
    document.getElementById('ma-weight').value = (config.maWeight * 100).toFixed(0);
    document.getElementById('display-balance').textContent = `${config.balance.toLocaleString()}`;
    document.getElementById('display-risk').textContent = `${(config.risk * 100).toFixed(1)}%`;
    updateDashboard();
}

updateTime();
setInterval(updateTime, 1000);
connectWebSocket();
fetchHistoricalData();
setInterval(updateDashboard, 5000);
setInterval(fetchHistoricalData, 300000);
</script>
